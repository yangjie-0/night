# データが表示されない問題の診断手順

## 現象
- プログラムは「挿入成功」と表示される
- しかし pgAdmin4 でデータが見えない

---

## 原因と対策（優先順位順）

### 🔴 原因1：pgAdminのクエリエディタで自動コミットがOFFになっている（最頻出）

#### 確認方法
pgAdmin4 のクエリエディタで以下を実行：

```sql
-- 現在のトランザクション状態を確認
SELECT txid_current();
-- 数値が返ってくる = トランザクション中
-- エラーが返ってくる = トランザクション外
```

#### 解決方法A：手動でCOMMIT

```sql
-- 1. まず COMMIT を実行
COMMIT;

-- 2. その後、再度データを確認
SELECT COUNT(*) FROM m_product;
SELECT COUNT(*) FROM m_product_eav;
SELECT COUNT(*) FROM m_product_management;
```

#### 解決方法B：自動コミットを有効化

```
1. pgAdmin4 のクエリエディタを開く
2. メニューバー：クエリ → 自動コミット
3. チェックが入っていることを確認
4. 再度クエリを実行
```

---

### 🟡 原因2：pgAdminのキャッシュ問題

#### 解決方法：テーブルをリフレッシュ

```
1. pgAdmin4 の左側のツリーで該当テーブルを右クリック
2. 「更新」または「Refresh」をクリック
3. もしくは F5 キーを押す
```

#### または：クエリを再実行

```sql
-- COUNT で確認（キャッシュされにくい）
SELECT COUNT(*) FROM m_product;
SELECT COUNT(*) FROM m_product_eav;

-- 最新のデータを取得
SELECT * FROM m_product ORDER BY cre_at DESC LIMIT 10;
SELECT * FROM m_product_eav ORDER BY cre_at DESC LIMIT 10;
```

---

### 🟢 原因3：WHERE句の条件が厳しすぎる

#### 確認方法

```sql
-- まず全件数を確認（WHERE句なし）
SELECT COUNT(*) FROM m_product;
-- 結果が 0 なら本当にデータがない
-- 結果が 0 以外なら WHERE句の問題

-- batch_id で絞り込んで確認
SELECT COUNT(*) FROM m_product WHERE batch_id = '您的batch_id';
-- 結果が 0 なら batch_id が間違っている可能性

-- 最新のbatch_idを確認
SELECT DISTINCT batch_id, COUNT(*)
FROM m_product
GROUP BY batch_id
ORDER BY batch_id DESC
LIMIT 5;
```

---

### 🔵 原因4：別のデータベースに接続している

#### 確認方法

```sql
-- 現在接続しているデータベースを確認
SELECT current_database();
-- 期待する結果：productdata（または您のデータベース名）

-- すべてのデータベースを確認
SELECT datname FROM pg_database;
```

#### 解決方法

```
1. pgAdmin4 で正しいデータベースに接続しているか確認
2. 左側のツリーで「productdata」データベースが選択されているか確認
3. 必要に応じて接続を切り替える
```

---

### 🟣 原因5：プログラム側でトランザクションがコミットされていない

#### 確認方法：プログラムのログを確認

```
ログに以下が含まれているか確認：
✅ "COMMIT successful" または "トランザクションコミット"
✅ "batch_status='COMPLETED'" または "batch_status='PARTIAL'"
❌ "ROLLBACK" や "エラー" が含まれていないか
```

#### コードの確認箇所

`Services/Upsert/UpsertService.cs` の以下の部分：

```csharp
await tx.CommitAsync(cancellationToken); // ← この行が実行されているか？
```

#### データベースで確認

```sql
-- batch_run テーブルで処理状態を確認
SELECT
    batch_id,
    batch_status,
    started_at,
    ended_at,
    counts_json
FROM batch_run
ORDER BY started_at DESC
LIMIT 5;

-- batch_status の意味：
-- 'RUNNING'   = 実行中
-- 'COMPLETED' = 正常終了
-- 'PARTIAL'   = 一部成功
-- 'FAILED'    = 失敗
```

---

## 総合診断SQL

以下のSQLを実行して、現在の状態を総合的に確認：

```sql
-- ============================================
-- データ存在確認（総合診断）
-- ============================================

-- 1. 接続情報の確認
SELECT
    current_database() AS "接続中のDB",
    current_user AS "接続ユーザー",
    version() AS "PostgreSQLバージョン";

-- 2. トランザクション状態の確認
SELECT
    CASE
        WHEN pg_backend_pid() IN (SELECT pid FROM pg_stat_activity WHERE state = 'idle in transaction')
        THEN 'トランザクション中（未コミット）'
        ELSE 'トランザクション外'
    END AS "トランザクション状態";

-- 3. 各テーブルのデータ件数
SELECT
    'm_product' AS テーブル名,
    COUNT(*) AS 件数,
    MAX(cre_at) AS 最終作成日時
FROM m_product
UNION ALL
SELECT
    'm_product_eav',
    COUNT(*),
    MAX(cre_at)
FROM m_product_eav
UNION ALL
SELECT
    'm_product_ident',
    COUNT(*),
    MAX(cre_at)
FROM m_product_ident
UNION ALL
SELECT
    'm_product_management',
    COUNT(*),
    MAX(cre_at)
FROM m_product_management
UNION ALL
SELECT
    'm_product_management_eav',
    COUNT(*),
    MAX(cre_at)
FROM m_product_management_eav;

-- 4. 最新のバッチ処理状態
SELECT
    batch_id,
    batch_status,
    data_kind,
    group_company_cd,
    started_at,
    ended_at,
    counts_json
FROM batch_run
ORDER BY started_at DESC
LIMIT 5;

-- 5. 最新のエラー記録（あれば）
SELECT
    batch_id,
    temp_row_id,
    step,
    error_cd,
    error_message,
    occurred_at
FROM record_error
ORDER BY occurred_at DESC
LIMIT 10;
```

---

## よくあるパターンと解決方法

### パターン1：「データが本当に入っていない」

**症状：**
```sql
SELECT COUNT(*) FROM m_product; -- 結果：0
```

**原因：**
- プログラムでエラーが発生してロールバックされた
- batch_id が間違っている

**確認方法：**
```sql
-- エラーログを確認
SELECT * FROM record_error ORDER BY occurred_at DESC LIMIT 10;

-- バッチ処理の状態を確認
SELECT batch_id, batch_status, counts_json
FROM batch_run
WHERE batch_status = 'FAILED'
ORDER BY started_at DESC;
```

---

### パターン2：「pgAdminで見えないだけ」

**症状：**
```sql
-- pgAdmin で実行すると 0 件
SELECT COUNT(*) FROM m_product; -- 結果：0

-- でもプログラムのログには「挿入成功」と表示
```

**原因：**
- pgAdmin でトランザクションが開いたまま
- 古いデータをキャッシュしている

**解決方法：**
```sql
-- 1. まず COMMIT
COMMIT;

-- 2. 再度確認
SELECT COUNT(*) FROM m_product; -- 今度は件数が表示されるはず
```

---

### パターン3：「一部のテーブルだけデータがない」

**症状：**
```sql
SELECT COUNT(*) FROM m_product;      -- 結果：10 件 ✅
SELECT COUNT(*) FROM m_product_eav;  -- 結果：0 件  ❌
```

**原因：**
- is_golden_eav = FALSE になっている
- 属性定義（m_attr_definition）の設定が間違っている

**確認方法：**
```sql
-- 属性定義を確認
SELECT
    attr_cd,
    is_golden_product,
    is_golden_eav,
    target_column,
    is_active
FROM m_attr_definition
WHERE is_active = TRUE
ORDER BY attr_cd;

-- is_golden_eav = TRUE の属性が存在するか確認
SELECT COUNT(*)
FROM m_attr_definition
WHERE is_golden_eav = TRUE AND is_active = TRUE;
-- 結果が 0 なら、属性定義に問題がある
```

---

## トラブルシューティングチェックリスト

### ステップ1：基本確認
- [ ] pgAdmin で正しいデータベース（productdata）に接続しているか
- [ ] テーブル名のスペルミスがないか
- [ ] `COMMIT;` を実行したか

### ステップ2：データの存在確認
- [ ] `SELECT COUNT(*) FROM m_product;` で 0 以外が返ってくるか
- [ ] batch_run テーブルで batch_status が 'COMPLETED' か 'PARTIAL' になっているか
- [ ] record_error テーブルにエラーが記録されていないか

### ステップ3：プログラムログの確認
- [ ] ログに "COMMIT successful" が含まれているか
- [ ] ログに "INSERT" や "UPDATE" が含まれているか
- [ ] ログに "ERROR" や "ROLLBACK" が含まれていないか

### ステップ4：属性定義の確認
- [ ] m_attr_definition で is_golden_product = TRUE の属性が存在するか
- [ ] m_attr_definition で is_golden_eav = TRUE の属性が存在するか
- [ ] target_column が正しく設定されているか

---

## 緊急対応：データをすぐに確認したい場合

```sql
-- とりあえず COMMIT してから全件確認
COMMIT;

-- 全テーブルの件数を確認
SELECT
    (SELECT COUNT(*) FROM m_product) AS m_product件数,
    (SELECT COUNT(*) FROM m_product_eav) AS m_product_eav件数,
    (SELECT COUNT(*) FROM m_product_ident) AS m_product_ident件数,
    (SELECT COUNT(*) FROM m_product_management) AS m_product_management件数,
    (SELECT COUNT(*) FROM m_product_management_eav) AS m_product_management_eav件数;

-- 最新の10件を表示
SELECT * FROM m_product ORDER BY cre_at DESC LIMIT 10;
SELECT * FROM m_product_eav ORDER BY cre_at DESC LIMIT 10;
SELECT * FROM m_product_management ORDER BY cre_at DESC LIMIT 10;
```

---

## まとめ

**最も可能性が高い原因：**
1. 🔴 **pgAdmin でトランザクションが開いたまま** → `COMMIT;` を実行
2. 🟡 **pgAdmin のキャッシュ** → F5 でリフレッシュ
3. 🟢 **WHERE句の条件が厳しい** → `COUNT(*)` で全件確認

**まず試すこと：**
```sql
-- 1. COMMIT
COMMIT;

-- 2. 全件数を確認
SELECT COUNT(*) FROM m_product;

-- 3. 最新データを確認
SELECT * FROM m_product ORDER BY cre_at DESC LIMIT 5;
```

これで大抵の問題は解決します！
