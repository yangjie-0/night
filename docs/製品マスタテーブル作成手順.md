# 製品マスタテーブル作成手順

## 問題の診断

pgAdmin4で以下のクエリを実行して、現在の状態を確認してください：

```sql
-- table_check.sql を実行してください
```

---

## パターン1：テーブルが存在しない場合

### 症状
```
❌ m_product_management が存在しない
❌ m_product_management_eav が存在しない
```

### 解決方法

**ステップ1：createTable1105.sql を実行する**

pgAdmin4で以下を実行：

1. `init/createTable1105.sql` ファイルを開く
2. 全文を選択してコピー
3. pgAdmin4のクエリエディタに貼り付け
4. 実行ボタンをクリック

**注意事項：**
- m_product テーブルは既に存在している可能性があるため、エラーが出る可能性があります
- その場合は、m_product テーブルのCREATE文をコメントアウトしてください（行4～25）

**ステップ2：テーブル作成の確認**

```sql
-- テーブルが作成されたか確認
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('m_product_management', 'm_product_management_eav');
```

期待される結果：
```
m_product_management
m_product_management_eav
```

---

## パターン2：テーブルは存在するが batch_id 列がない場合

### 症状
```
✅ m_product_management が存在する
❌ batch_id 列が存在しない
```

### 解決方法

**ステップ1：現在のスキーマを確認**

```sql
-- m_product_management の列構造を確認
SELECT ordinal_position, column_name, data_type
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'm_product_management'
ORDER BY ordinal_position;
```

**ステップ2-A：batch_id 列がない場合 → 列を追加**

```sql
-- m_product_management に batch_id 列を追加
ALTER TABLE m_product_management
ADD COLUMN batch_id TEXT;

-- m_product_management_eav に batch_id 列を追加
ALTER TABLE m_product_management_eav
ADD COLUMN batch_id TEXT;
```

**ステップ2-B：列の順序が異なる場合 → テーブルを再作成**

⚠️ **注意：この方法は既存データを削除します！**

```sql
-- ステップ1：外部キー制約を削除
ALTER TABLE m_product_management_eav DROP CONSTRAINT IF EXISTS fk_pm_eav_product_management;
ALTER TABLE m_product_management_eav DROP CONSTRAINT IF EXISTS fk_pm_eav_attr;
ALTER TABLE m_product_management_image DROP CONSTRAINT IF EXISTS fk_pm_image_product_management;
ALTER TABLE m_product_management DROP CONSTRAINT IF EXISTS fk_product_management_brand;
ALTER TABLE m_product_management DROP CONSTRAINT IF EXISTS fk_product_management_category;

-- ステップ2：テーブルを削除
DROP TABLE IF EXISTS m_product_management_image CASCADE;
DROP TABLE IF EXISTS m_product_management_eav CASCADE;
DROP TABLE IF EXISTS m_product_management CASCADE;

-- ステップ3：createTable1105.sql の製品マスタ部分を実行
-- 行227～296を実行してください
```

---

## パターン3：データベース接続が間違っている場合

### 症状
```
接続中のDB: postgres（または他のDB名）
期待するDB名: productdata（または您のデータベース名）
```

### 解決方法

**pgAdmin4で正しいデータベースに接続し直す**

1. 左側のツリーで「productdata」データベースを右クリック
2. 「クエリツール」を選択
3. 新しいクエリエディタで再度クエリを実行

---

## 確認手順（全パターン共通）

### 1. テーブル構造の確認

```sql
-- m_product_management の列構造を確認
SELECT
    ordinal_position AS "位置",
    column_name AS "列名",
    data_type AS "データ型"
FROM information_schema.columns
WHERE table_schema = 'public'
  AND table_name = 'm_product_management'
ORDER BY ordinal_position;
```

期待される結果（batch_id が位置10にあることを確認）：
```
位置 | 列名                           | データ型
-----|-------------------------------|----------
1    | g_product_management_id       | bigint
2    | group_company_id              | bigint
3    | source_product_management_cd  | text
4    | g_brand_id                    | bigint
5    | g_category_id                 | bigint
6    | description_text              | text
7    | is_provisional                | boolean
8    | source_product_cd             | bigint
9    | provenance_json               | jsonb
10   | batch_id                      | text      ← ここにあるか確認！
11   | is_active                     | boolean
12   | cre_at                        | timestamp with time zone
13   | upd_at                        | timestamp with time zone
```

### 2. データ件数の確認（テーブルが存在し、batch_id列がある場合のみ）

```sql
-- 製品マスタのデータ件数を確認
SELECT COUNT(*) AS "m_product_management 件数" FROM m_product_management;

-- 製品マスタEAVのデータ件数を確認
SELECT COUNT(*) AS "m_product_management_eav 件数" FROM m_product_management_eav;
```

### 3. 最新のデータを確認（テーブルが存在し、データがある場合のみ）

```sql
-- 最新の製品マスタレコードを確認
SELECT
    g_product_management_id,
    source_product_management_cd,
    g_brand_id,
    g_category_id,
    batch_id,
    cre_at
FROM m_product_management
ORDER BY cre_at DESC
LIMIT 5;

-- 最新の製品マスタEAVレコードを確認
SELECT
    g_product_management_id,
    attr_cd,
    attr_seq,
    COALESCE(value_text, value_num::text, value_cd) AS "値",
    batch_id,
    cre_at
FROM m_product_management_eav
ORDER BY cre_at DESC
LIMIT 10;
```

---

## よくある質問

### Q1: createTable1105.sql を実行したら「m_product already exists」というエラーが出ました

**A:** m_product テーブルは既に存在しているため、エラーが出ています。以下の手順で対処してください：

1. `createTable1105.sql` を開く
2. 行4～25（m_product テーブルのCREATE文）をコメントアウト
3. 行51以降（m_product_eav, m_product_ident, m_product_management等）のみを実行

### Q2: 外部キー制約エラーが出ました

**A:** 外部キー制約は以下のテーブルが存在している必要があります：

必須テーブル：
- m_company（会社マスタ）
- m_brand_g（ブランドマスタ）
- m_category_g（カテゴリマスタ）
- m_attr_definition（属性定義マスタ）

これらのテーブルが存在するか確認してください：

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('m_company', 'm_brand_g', 'm_category_g', 'm_attr_definition');
```

### Q3: シーケンスエラーが出ました

**A:** 商品ID用のシーケンスが存在しない場合、以下を実行してください：

```sql
-- 商品ID用シーケンス
CREATE SEQUENCE IF NOT EXISTS m_product_g_product_id_seq START 1;

-- 製品ID用シーケンス
CREATE SEQUENCE IF NOT EXISTS m_product_management_g_product_management_id_seq START 1;
```

---

## まとめ

### チェックリスト

- [ ] `table_check.sql` を実行して現在の状態を確認した
- [ ] 正しいデータベース（productdata）に接続している
- [ ] m_product_management テーブルが存在する
- [ ] m_product_management_eav テーブルが存在する
- [ ] 両方のテーブルに batch_id 列が存在する（位置10）
- [ ] 外部キー制約の参照先テーブル（m_company, m_brand_g, m_category_g, m_attr_definition）が存在する

### 次のステップ

テーブルが正しく作成されたら、以下を実行してプログラムを再実行してください：

```bash
dotnet run
```

---

## トラブルシューティング

問題が解決しない場合は、以下の情報を確認してください：

1. **table_check.sql の実行結果**をすべてコピー
2. **エラーメッセージ**の全文をコピー
3. **プログラムのログ**をコピー

これらの情報があれば、問題の原因を特定できます。
